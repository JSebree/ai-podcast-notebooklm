name: Daily Tech Digest

on:
  schedule:
    - cron: "0 12 * * *"   # 8 AM ET
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # üîê Secret validation (unchanged) ‚Ä¶
      # --------------- SNIP  ---------------

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: ü©∫ Smoke-test Newsdata
        env:
          NEWSDATA_API_KEY: ${{ secrets.NEWSDATA_API_KEY }}
        run: |
          echo "Key prefix: ${NEWSDATA_API_KEY:0:6}"
          response="$(curl --silent --show-error --get https://newsdata.io/api/1/news \
                     --data apikey=${NEWSDATA_API_KEY} \
                     --data language=en \
                     --data q="technology" \
                     --write-out '\nHTTP_STATUS:%{http_code}')"
          body="${response%HTTP_STATUS*}"
          status="${response##*HTTP_STATUS:}"
          echo "HTTP status: $status"
          echo "$body" | head -c 300
          [ "$status" -eq 200 ] || { echo "Newsdata smoke-test failed"; exit 1; }

      - name: üöÄ Run CrewAI workflow
        env:
          GOOGLE_SERVICE_ACCOUNT:  ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          GOOGLE_DRIVE_FOLDER_ID:  ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          NEWSDATA_API_KEY:        ${{ secrets.NEWSDATA_API_KEY }}
          YOUTUBE_API_KEY:         ${{ secrets.YOUTUBE_API_KEY }}
          OPENAI_API_KEY:          ${{ secrets.OPENAI_API_KEY }}
          TWITTER_BEARER_TOKEN:    ${{ secrets.TWITTER_BEARER_TOKEN }}
          TWILIO_ACCOUNT_SID:      ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN:       ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER:      ${{ secrets.TWILIO_FROM_NUMBER }}
          NOTIFY_PHONE:            ${{ secrets.NOTIFY_PHONE }}
          SMTP_USER:               ${{ secrets.SMTP_USER }}
          SMTP_PASS:               ${{ secrets.SMTP_PASS }}
          SMTP_HOST:               ${{ secrets.SMTP_HOST }}
          SMTP_PORT:               ${{ secrets.SMTP_PORT }}
          NOTIFY_EMAIL:            ${{ secrets.NOTIFY_EMAIL }}
          SHARE_WITH_EMAIL:        ${{ secrets.SHARE_WITH_EMAIL }}
        run: |
          set -e
          python crewai_workflow.py
