name: Daily Tech Digest
on:
  schedule:
    # 8 AM ET  ⇒  12:00 UTC (adjust for DST)
    - cron: "0 12 * * *"
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ─────────────────────────────────────────────────────────────
      # Validate that every required GitHub Secret is populated.
      # We first map secrets → env vars, then loop over the vars so we
      # can use normal shell expansion (${!var}).
      # ─────────────────────────────────────────────────────────────
      - name: Validate secrets
        env:
          GOOGLE_SERVICE_ACCOUNT:  ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          GOOGLE_DRIVE_FOLDER_ID:  ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          NEWSDATA_API_KEY:        ${{ secrets.NEWSDATA_API_KEY }}
          YOUTUBE_API_KEY:         ${{ secrets.YOUTUBE_API_KEY }}
          OPENAI_API_KEY:          ${{ secrets.OPENAI_API_KEY }}
          TWITTER_BEARER_TOKEN:    ${{ secrets.TWITTER_BEARER_TOKEN }}
          TWILIO_ACCOUNT_SID:      ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN:       ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER:      ${{ secrets.TWILIO_FROM_NUMBER }}
          NOTIFY_PHONE:            ${{ secrets.NOTIFY_PHONE }}
          SMTP_USER:               ${{ secrets.SMTP_USER }}
          SMTP_PASS:               ${{ secrets.SMTP_PASS }}
          SMTP_HOST:               ${{ secrets.SMTP_HOST }}
          SMTP_PORT:               ${{ secrets.SMTP_PORT }}
          NOTIFY_EMAIL:            ${{ secrets.NOTIFY_EMAIL }}
        run: |
          set -e
          missing=0
          for var in \
            GOOGLE_SERVICE_ACCOUNT GOOGLE_DRIVE_FOLDER_ID NEWSDATA_API_KEY \
            YOUTUBE_API_KEY OPENAI_API_KEY TWITTER_BEARER_TOKEN \
            TWILIO_ACCOUNT_SID TWILIO_AUTH_TOKEN TWILIO_FROM_NUMBER NOTIFY_PHONE \
            SMTP_USER SMTP_PASS SMTP_HOST SMTP_PORT NOTIFY_EMAIL
          do
            if [ -z "${!var}" ]; then
              echo "❌ $var is empty or missing" >&2
              missing=1
            else
              echo "✅ $var present"
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo "Aborting: one or more required secrets are missing." >&2
            exit 1
          fi

      - name: Install dependencies
        run: pip install -r requirements-lock.txt

      - name: Run CrewAI workflow
        env:
          GOOGLE_SERVICE_ACCOUNT:  ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
          GOOGLE_DRIVE_FOLDER_ID:  ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
          NEWSDATA_API_KEY:        ${{ secrets.NEWSDATA_API_KEY }}
          YOUTUBE_API_KEY:         ${{ secrets.YOUTUBE_API_KEY }}
          OPENAI_API_KEY:          ${{ secrets.OPENAI_API_KEY }}
          TWITTER_BEARER_TOKEN:    ${{ secrets.TWITTER_BEARER_TOKEN }}
          TWILIO_ACCOUNT_SID:      ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN:       ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER:      ${{ secrets.TWILIO_FROM_NUMBER }}
          NOTIFY_PHONE:            ${{ secrets.NOTIFY_PHONE }}
          SMTP_USER:               ${{ secrets.SMTP_USER }}
          SMTP_PASS:               ${{ secrets.SMTP_PASS }}
          SMTP_HOST:               ${{ secrets.SMTP_HOST }}
          SMTP_PORT:               ${{ secrets.SMTP_PORT }}
          NOTIFY_EMAIL:            ${{ secrets.NOTIFY_EMAIL }}
        run: |
          set -e
          python crewai_workflow.py
